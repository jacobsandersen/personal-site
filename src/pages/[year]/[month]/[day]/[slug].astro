---
import MicroformatRenderer from "~/components/microformat/MicroformatRenderer.astro";
import { validateYearMonthDayForPath } from "~/util/url";
import { findPost } from "~/lib/scribble/scribble";
import {getDateParts} from "~/util/dates";
import { getPermalinkUrl } from "~/util/mf2-util";

const { year, month, day, slug } = Astro.params

if (!validateYearMonthDayForPath(year, month, day)) {
  throw new Error(`Invalid date parameters: ${year}-${month}-${day}`)
}

const post = await findPost(slug!)
if (!post) {
  console.warn(`Post not found for slug: ${slug}`)
  return new Response(null, { status: 404 })
} 

const createdAtRaw = post.properties['created_at'] as string[]
if (!createdAtRaw || createdAtRaw.length === 0) {
  console.error(`Missing created_at date for post with slug ${slug}`)
  return new Response(null, { status: 404 })
}

const { year: createdYear, month: createdMonth, day: createdDay } = getDateParts(createdAtRaw[0])
if (createdYear !== year || createdMonth !== month || createdDay !== day) {
  return Astro.redirect(getPermalinkUrl(post.properties))
}
---

<MicroformatRenderer doc={post} />
