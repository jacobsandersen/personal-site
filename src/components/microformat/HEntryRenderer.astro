---
import { Mf2Properties } from '~/types/mf2-document'
import PermalinkLayout from '~/layouts/PermalinkLayout.astro'
import HEntryContent from './HEntryContent.astro'
import { discoverPostType, getExtractorForType } from '~/lib/discovery'
import { getPermalinkUrl } from '~/util/mf2-util'

export interface Props {
    props: Mf2Properties
    preview?: boolean
}

const { props, preview = false } = Astro.props

const cache = Astro.locals.runtime.env.personal_site_content_cache

const type = discoverPostType(props)
const extractor = getExtractorForType(type, props)
const summary = extractor.getSummary()
const title = extractor.getTitle()
const permalink = getPermalinkUrl(props)

const shouldShortCircuitWithSummary = preview && !!summary
const content = shouldShortCircuitWithSummary ? null : await extractor.getPost(cache)

const contentProps = { extractor, preview, permalink, content }
---

{preview ? (
    <HEntryContent {...contentProps} />
) : (
    <PermalinkLayout title={title}>
        <HEntryContent {...contentProps} />
    </PermalinkLayout>
)}