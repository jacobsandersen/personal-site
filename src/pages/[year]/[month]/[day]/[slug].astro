---
import type { Mf2Document } from "~/types/mf2-document";
import MicroformatRenderer from "~/components/microformat/MicroformatRenderer.astro";
import { validateYearMonthDayForPath } from "~/util/url";

const { year, month, day, slug } = Astro.params

if (!validateYearMonthDayForPath(year, month, day)) {
  throw new Error(`Invalid date parameters: ${year}-${month}-${day}`)
}

const url = new URL("https://scribble.jacobandersen.dev/query/list")
url.searchParams.set("slug", slug!)
url.searchParams.set("year", year!)
url.searchParams.set("month", month!)
url.searchParams.set("day", day!)
url.searchParams.set("limit", "1")

console.log(`Fetching blog post data from: ${url.toString()}`)

const result = await fetch(url.toString(), {
  headers: {
    'Accept': 'application/json',
  },
})

if (!result || !result.ok) {
  return new Response(null, { status: 404 })
}

const data = await result.json() as Mf2Document[]
if (!data || data.length === 0) {
  return new Response(null, { status: 404 })
}

const doc = data[0]
const isDeleted = Array.isArray(doc.properties.deleted) ? doc.properties.deleted.includes(true) : false
const isVisible = Array.isArray(doc.properties['post-status']) ? ['published', 'unlisted'].includes(doc.properties['post-status'][0] as string) : true

if (isDeleted || !isVisible) {
  return new Response(null, { status: 404 })
}
---

<MicroformatRenderer doc={doc} />
