---
import type { Mf2Document } from "~/types/mf2-document";
import MicroformatRenderer from "~/components/microformat/MicroformatRenderer.astro";
import { validateYearMonthDayForPath } from "~/util/url";

const { year, month, day, slug } = Astro.params

if (!validateYearMonthDayForPath(year, month, day)) {
  throw new Error(`Invalid date parameters: ${year}-${month}-${day}`)
}

const base = new Date(`${year}-${month}-${day}T00:00:00Z`)
const nextDay = new Date(base)
nextDay.setUTCDate(base.getUTCDate() + 1)

const result = await Astro.locals.runtime.env.scribble_db
  .prepare(`select doc from scribble_content 
    where json_extract(doc, '$.properties.slug[0]') = ? 
    and json_extract(doc, '$.properties.created_at[0]') >= ? 
    and json_extract(doc, '$.properties.created_at[0]') < ?
    limit 1`)
  .bind(slug, base.toISOString(), nextDay.toISOString())
  .first()

if (!result) {
  return new Response(null, { status: 404 })
}

const doc = JSON.parse(result['doc'] as string) as Mf2Document
const isDeleted = Array.isArray(doc.properties.deleted) ? doc.properties.deleted.includes(true) : false
const isVisible = Array.isArray(doc.properties['post-status']) ? ['published', 'unlisted'].includes(doc.properties['post-status'][0] as string) : true

if (isDeleted || !isVisible) {
  return new Response(null, { status: 404 })
}
---

<MicroformatRenderer doc={doc} />
