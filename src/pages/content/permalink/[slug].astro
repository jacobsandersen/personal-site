---
import type { Mf2Document } from "~/types/mf2-document";
import MicroformatRenderer from "~/components/microformat/MicroformatRenderer.astro";

export const prerender = false

const { scribble_db } = Astro.locals.runtime.env
const stmt = scribble_db.prepare("select doc from scribble_content where json_extract(doc, '$.properties.slug') = json_array(?) limit 1")
const result = await stmt.bind(Astro.params.slug).first()
if (!result) {
  return new Response(null, { status: 404 })
}

const doc = JSON.parse(result['doc'] as string) as Mf2Document
const isDeleted = Array.isArray(doc.properties.deleted) ? doc.properties.deleted.includes(true) : false
const isVisible = Array.isArray(doc.properties['post-status']) ? ['published', 'unlisted'].includes(doc.properties['post-status'][0] as string) : true

if (isDeleted || !isVisible) {
  return new Response(null, { status: 404 })
}
---

<MicroformatRenderer doc={doc} />
